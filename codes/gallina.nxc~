#define DELANTE 0
#define IZQUIERDA -90
#define DERECHA 90

#define ACTIVAR_MOTORES

int sensor;

int min(int a, int b){
      return (a > b) ? b : a;
}

//1 - derecha
//0 - default
//2 - izquierda
int sensar(){

     int state = 0;

     int cuarto_izq = 0;
     int izq = 0;

     int cuarto_der = 0;
     int der = 0;

     int min_der = 0;
     int min_izq = 0;

     int min_obstaculo = 0;
     
     //VOLTEAR CUARTO IZQ
     RotateMotor(OUT_B,20,45);
     state = 2;
     cuarto_izq = sensor;
     Wait(700);

     //VOLTEAR IZQ
     RotateMotor(OUT_B,20,45); //regresar a delante
     state = 2;
     izq = sensor;
     Wait(700);

     //REGRESAR A FRENTE
     RotateMotor(OUT_B,20,-90); //ir a derecha
     
     //VOLTEAR CUARTO DERECHA
     RotateMotor(OUT_B,20,-45);
     state = 1;
     cuarto_der = sensor;
     Wait(700);
     
     //VOLTEAR DERECHA
     RotateMotor(OUT_B,20,-45); //regresar a delante
     state = 1;
     der = sensor;
     Wait(700);
     
     //REGRESAR A FRENTE
     RotateMotor(OUT_B,20,90); //ir a derecha

     //saber cual es el minimo
     min_izq = min(cuarto_izq,izq);
     min_der = min(cuarto_der,der);

     min_obstaculo = min(min_izq,min_der);

     if(min_obstaculo == min_izq){
          state = 2;
     }else{
	  state = 1;
     }
     

     Wait(1000);
     
     return state;

}

task print(){
     
     SetSensorLowspeed(S2);

     while(true){
     
     	  sensor = SensorUS(S2);
     	  TextOut(0,LCD_LINE6, "ULTRASONICO: " + NumToStr(sensor) + "       ");
	  
     }
}

task mover(){

     while(true){
	int objeto = -1;

	if(sensor < 15){
	      TextOut(0,LCD_LINE8, "¡¡ALERTA!!" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
              
	      Off(OUT_AC);
#endif	
	}else if(sensor < 25){
	      
	      TextOut(0,LCD_LINE8, "menor a 25" + " " + NumToStr(sensor) + "       ");

	      //hacer rutina de escaneo
	      
	      objeto = sensar();
	      
	      if(objeto == 1)
	      		TextOut(0,LCD_LINE8, "-> derecha         ");

	      if(objeto == 2)
	      		TextOut(0,LCD_LINE8, "-> izquierda       ");

	      Wait(10000);
    	}else{
	      TextOut(0,LCD_LINE8, "seguramente mayor a 25" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
	      Off(OUT_AC);
#endif
     	}
	
	Wait(1000);

     }
     
}

//talvez pasarle grados
void girar_derecha(){

     RotateMotor(OUT_C,30,-360); //ir a derecha
     RotateMotor(OUT_A,30,360); //ir a derecha

     Wait(2000);

}

task gallina(){

     Wait(5000);

     while(true){
	if(sensor < 15){
	      TextOut(0,LCD_LINE8, "¡¡ALERTA!!" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
	      OnRev(OUT_AC,70);
	      Wait(1000);
	      //girar_derecha();
#endif	
	}else if(sensor < 20){
	      TextOut(0,LCD_LINE8, "menor a 20" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
	      OnRev(OUT_AC,50);
	      Wait(1000);
	      //girar_derecha();
#endif
	}else if(sensor < 25){
	      TextOut(0,LCD_LINE8, "menor a 25" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
	      OnRev(OUT_AC,30);
	      Wait(1000);
	      //girar_derecha();
#endif
    	}else{
	      TextOut(0,LCD_LINE8, "seguramente mayor a 25" + " " + NumToStr(sensor) + "       ");
#ifdef ACTIVAR_MOTORES
	      OnFwd(OUT_AC,20);
#endif
     	}
	
	Wait(1000);
     }
}

task main(){


     //Ir hacia delante hasta encontrar un obstaculo
     //si encuentro un cambio drastico de +/- 10 cm me detengo

     Precedes(print,mover);
     //Precedes(print,gallina);
     

}